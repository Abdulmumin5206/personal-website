<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog | Abdulmumin</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header will be dynamically inserted here -->
    <div id="header-container"></div>

    <script>
        function loadHeader() {
            fetch("header.html")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("header-container").innerHTML = data;
                })
                .catch(error => console.error("Error loading header:", error));
        }
        loadHeader();
    </script>

    <main class="content">
        <h1>My Blog</h1>

        <!-- Blog Post Form -->
        <div id="blog-form">
            <h3>Create a New Blog Post</h3>
            <input type="text" id="blog-title" placeholder="Enter Blog Title" required>
            <textarea id="blog-content" placeholder="Write your blog post..." required></textarea>
            <button id="submit-post">Post</button>
        </div>

        <div id="blog-posts">Loading...</div> <!-- Blog posts will be displayed here -->
    </main>

    <script type="module">
        import { db } from "./firebase.js";
        import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const blogContainer = document.getElementById("blog-posts");
        const titleInput = document.getElementById("blog-title");
        const contentInput = document.getElementById("blog-content");
        const submitBtn = document.getElementById("submit-post");

        // Notion API Credentials
        const notionDatabaseId = "19b5d2508456807397fedeceebcf8aba"; // Your Notion Database ID
        const notionApiKey = "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"; // Your Notion API Key

        // Fetch blog posts from Notion API
        async function fetchNotionBlogPosts() {
            const response = await fetch(`https://api.notion.com/v1/databases/${notionDatabaseId}/query`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${notionApiKey}`,
                    "Content-Type": "application/json",
                    "Notion-Version": "2022-06-28"
                }
            });

            const data = await response.json();
            blogContainer.innerHTML = ""; // Clear previous content

            data.results.forEach((post) => {
                const title = post.properties.Title.title[0]?.text.content || "Untitled";
                const content = post.properties.Content.rich_text[0]?.text.content || "No content available.";
                const date = new Date(post.properties.Date.date.start).toLocaleDateString();

                blogContainer.innerHTML += `
                    <article class="blog-post">
                        <h2>${title}</h2>
                        <p>${content}</p>
                        <small>Published on: ${date}</small>
                        <hr>
                    </article>
                `;
            });
        }

        // Add a new blog post to Firebase
        async function addBlogPost() {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (title === "" || content === "") {
                alert("Please enter a title and content!");
                return;
            }

            await addDoc(collection(db, "BlogPosts"), {
                title: title,
                content: content,
                date: serverTimestamp(),
            });

            titleInput.value = "";
            contentInput.value = "";

            alert("Blog post added successfully!");
            fetchNotionBlogPosts(); // Refresh posts
        }

        submitBtn.addEventListener("click", addBlogPost);

        // Function to delete a blog post
        window.deletePost = async function (postId) {
            if (confirm("Are you sure you want to delete this post?")) {
                await deleteDoc(doc(db, "BlogPosts", postId));
                alert("Blog post deleted!");
                fetchNotionBlogPosts(); // Refresh posts
            }
        }

        // Function to enable editing a post
        window.editPost = function (postId) {
            const titleElement = document.getElementById(`title-${postId}`);
            const contentElement = document.getElementById(`content-${postId}`);
            const saveButton = document.querySelector(`#post-${postId} button[onclick="savePost('${postId}')"]`);
            const editButton = document.querySelector(`#post-${postId} button[onclick="editPost('${postId}')"]`);

            titleElement.contentEditable = "true";
            contentElement.contentEditable = "true";
            saveButton.style.display = "inline";
            editButton.style.display = "none";
        }

        // Function to save an edited post
        window.savePost = async function (postId) {
            const titleElement = document.getElementById(`title-${postId}`).innerText;
            const contentElement = document.getElementById(`content-${postId}`).innerText;

            await updateDoc(doc(db, "BlogPosts", postId), {
                title: titleElement,
                content: contentElement,
                date: serverTimestamp(),
            });

            alert("Blog post updated!");
            fetchNotionBlogPosts(); // Refresh posts
        }

        fetchNotionBlogPosts(); // Load blog posts from Notion
    </script>

</body>
</html>
