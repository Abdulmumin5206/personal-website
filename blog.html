<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog | Abdulmumin</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header will be dynamically inserted here -->
    <div id="header-container"></div>

    <script>
        function loadHeader() {
            fetch("header.html")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("header-container").innerHTML = data;
                })
                .catch(error => console.error("Error loading header:", error));
        }
        loadHeader();
    </script>

    <main class="content">
        <h1>My Blog</h1>

        <!-- Blog Post Form -->
        <div id="blog-form">
            <h3>Create a New Blog Post</h3>
            <input type="text" id="blog-title" placeholder="Enter Blog Title" required>
            <textarea id="blog-content" placeholder="Write your blog post..." required></textarea>
            <button id="submit-post">Post</button>
        </div>

        <div id="blog-posts">Loading...</div> <!-- Blog posts will be displayed here -->
    </main>

    <script type="module">
        import { db } from "./firebase.js";
        import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const blogContainer = document.getElementById("blog-posts");
        const titleInput = document.getElementById("blog-title");
        const contentInput = document.getElementById("blog-content");
        const submitBtn = document.getElementById("submit-post");

        // Load cached posts first
        function loadCachedPosts() {
            const cachedData = localStorage.getItem("blogPosts");
            if (cachedData) {
                blogContainer.innerHTML = cachedData;
            } else {
                blogContainer.innerHTML = "Loading...";
            }
        }

        // Fetch blog posts from Firestore
        async function fetchBlogPosts() {
            const querySnapshot = await getDocs(collection(db, "BlogPosts"));
            let postsHTML = "";

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const postId = doc.id; 

                postsHTML += `
                    <article class="blog-post" id="post-${postId}">
                        <h2 contenteditable="false" id="title-${postId}">${data.title}</h2>
                        <p contenteditable="false" id="content-${postId}">${data.content}</p>
                        <small>${new Date(data.date.seconds * 1000).toLocaleDateString()}</small>
                        
                        <button onclick="editPost('${postId}')">Edit</button>
                        <button onclick="deletePost('${postId}')">Delete</button>
                        <button onclick="savePost('${postId}')" style="display:none;">Save</button>
                        <hr>
                    </article>
                `;
            });

            if (querySnapshot.empty) {
                postsHTML = "<p>No blog posts found.</p>";
            }

            blogContainer.innerHTML = postsHTML;
            localStorage.setItem("blogPosts", postsHTML);
        }

        // Add a new blog post
        async function addBlogPost() {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (title === "" || content === "") {
                alert("Please enter a title and content!");
                return;
            }

            await addDoc(collection(db, "BlogPosts"), {
                title: title,
                content: content,
                date: serverTimestamp(),
            });

            titleInput.value = "";
            contentInput.value = "";

            alert("Blog post added successfully!");
            fetchBlogPosts(); // Refresh posts
        }

        submitBtn.addEventListener("click", addBlogPost);

        // Function to delete a blog post
        window.deletePost = async function (postId) {
            if (confirm("Are you sure you want to delete this post?")) {
                await deleteDoc(doc(db, "BlogPosts", postId));
                alert("Blog post deleted!");
                fetchBlogPosts(); // Refresh posts
            }
        }

        // Function to enable editing a post
        window.editPost = function (postId) {
            const titleElement = document.getElementById(`title-${postId}`);
            const contentElement = document.getElementById(`content-${postId}`);
            const saveButton = document.querySelector(`#post-${postId} button[onclick="savePost('${postId}')"]`);
            const editButton = document.querySelector(`#post-${postId} button[onclick="editPost('${postId}')"]`);

            titleElement.contentEditable = "true";
            contentElement.contentEditable = "true";
            saveButton.style.display = "inline";
            editButton.style.display = "none";
        }

        // Function to save an edited post
        window.savePost = async function (postId) {
            const titleElement = document.getElementById(`title-${postId}`).innerText;
            const contentElement = document.getElementById(`content-${postId}`).innerText;

            await updateDoc(doc(db, "BlogPosts", postId), {
                title: titleElement,
                content: contentElement,
                date: serverTimestamp(),
            });

            alert("Blog post updated!");
            fetchBlogPosts(); // Refresh posts
        }

        loadCachedPosts(); // Show cached posts first
        fetchBlogPosts(); // Fetch latest posts in the background
    </script>

</body>
</html>
